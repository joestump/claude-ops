{{/* Governing: SPEC-0021 REQ "TL;DR Page Rendering", REQ "Dashboard Stats HUD", REQ "Last Run Status Bar", REQ "Multiple Session Summaries", REQ "Unified Activity Feed" */}}
{{define "index.html"}}
<div class="max-w-6xl" id="overview-content">
    <h1 class="text-2xl font-semibold mb-6">TL;DR</h1>

    {{/* Stats HUD — 2 rows of 4 DaisyUI stat tiles */}}
    {{/* Governing: SPEC-0021 REQ "Dashboard Stats HUD" */}}
    <section class="mb-6">
        {{if .Stats}}
        <div class="grid grid-cols-4 bg-white border border-border rounded-lg shadow overflow-hidden">
            <div class="px-5 py-4 border-b border-r border-border">
                <div class="text-xs text-muted mb-1">Total Runs</div>
                <div class="text-2xl font-semibold text-charcoal tabular-nums">{{.Stats.TotalRuns}}</div>
                <div class="text-xs text-muted mt-1">root sessions</div>
            </div>
            <div class="px-5 py-4 border-b border-r border-border">
                <div class="text-xs text-muted mb-1">Escalations</div>
                <div class="text-2xl font-semibold text-charcoal tabular-nums">{{.Stats.Escalations}}</div>
                <div class="text-xs text-muted mt-1">child sessions</div>
            </div>
            <div class="px-5 py-4 border-b border-r border-border">
                <div class="text-xs text-muted mb-1">Remediations</div>
                <div class="text-2xl font-semibold text-charcoal tabular-nums">{{.Stats.Remediations}}</div>
                <div class="text-xs text-muted mt-1">tier-3 sessions</div>
            </div>
            <div class="px-5 py-4 border-b border-border">
                <div class="text-xs text-muted mb-1">Success %</div>
                <div class="text-2xl font-semibold tabular-nums {{if gt .Stats.SuccessRate 0.8}}text-green-600{{else if gt .Stats.SuccessRate 0.5}}text-yellow-600{{else}}text-red-600{{end}}">{{fmtPct .Stats.SuccessRate}}</div>
                <div class="text-xs text-muted mt-1">completed / total</div>
            </div>
            <div class="px-5 py-4 border-r border-border">
                <div class="text-xs text-muted mb-1">Total Cost</div>
                <div class="text-2xl font-semibold text-charcoal font-mono tabular-nums">{{fmtCostVal .Stats.TotalCostUSD}}</div>
                <div class="text-xs text-muted mt-1">all sessions</div>
            </div>
            <div class="px-5 py-4 border-r border-border">
                <div class="text-xs text-muted mb-1">Critical (24h)</div>
                <div class="text-2xl font-semibold tabular-nums {{if gt .Stats.CriticalEvents 0}}text-red-600{{else}}text-charcoal{{end}}">{{.Stats.CriticalEvents}}</div>
                <div class="text-xs text-muted mt-1">critical events</div>
            </div>
            <div class="px-5 py-4 border-r border-border">
                <div class="text-xs text-muted mb-1">Memories</div>
                <div class="text-2xl font-semibold text-charcoal tabular-nums">{{.Stats.ActiveMemories}}</div>
                <div class="text-xs text-muted mt-1"><a href="/memories" class="text-accent hover:underline">active memories</a></div>
            </div>
            <div class="px-5 py-4">
                <div class="text-xs text-muted mb-1">Avg Duration</div>
                <div class="text-2xl font-semibold text-charcoal font-mono tabular-nums">{{fmtMsVal .Stats.AvgDurationMs}}</div>
                <div class="text-xs text-muted mt-1">per session</div>
            </div>
        </div>
        {{else}}
        <div class="card-base text-sm text-muted">Stats unavailable.</div>
        {{end}}
    </section>

    {{/* Last Run status bar */}}
    {{/* Governing: SPEC-0021 REQ "Last Run Status Bar" */}}
    <section class="mb-6" id="last-run-bar"
        hx-get="/" hx-trigger="every 10s" hx-select="#last-run-bar-inner" hx-target="#last-run-bar-inner" hx-swap="outerHTML">
        <div id="last-run-bar-inner">
        {{if .LastSession}}
        <div class="card-base flex flex-wrap items-center gap-3 py-2.5 text-sm">
            <span class="text-xs font-semibold text-muted uppercase tracking-wide">Last Run</span>
            <a href="/sessions/{{.LastSession.ID}}" class="font-medium text-accent hover:underline font-mono">#{{.LastSession.ID}}</a>
            <span class="badge-pill {{statusClass .LastSession.Status}}">{{.LastSession.Status}}</span>
            <span class="text-xs text-muted">Tier {{.LastSession.Tier}} / {{tierLabel .LastSession.Tier}}</span>
            {{if .LastSession.CostUSD}}<span class="text-xs font-mono text-charcoal">{{fmtCost .LastSession.CostUSD}}</span>{{end}}
            <span class="text-xs text-muted">{{fmtDuration .LastSession.StartedAt .LastSession.EndedAt}}</span>
            <span class="text-xs text-muted ml-auto">{{fmtTime .LastSession.StartedAt}}</span>
        </div>
        {{else}}
        <div class="card-base text-sm text-muted">No sessions recorded yet.</div>
        {{end}}
        </div>
    </section>

    {{/* TL;DR + What Happened */}}
    {{/* Governing: SPEC-0021 REQ "Multiple Session Summaries" */}}
    {{if .LastSummary}}
    {{/* Session meta row — shared by both cards */}}
    <div class="flex items-center gap-3 mb-2 px-1">
        <a href="/sessions/{{.LastSummary.ID}}" class="font-medium text-accent hover:underline font-mono text-sm">#{{.LastSummary.ID}}</a>
        <span class="badge-pill {{statusClass .LastSummary.Status}} text-xs">{{.LastSummary.Status}}</span>
        <span class="text-xs text-muted">Tier {{.LastSummary.Tier}} / {{tierLabel .LastSummary.Tier}}</span>
        {{if .LastSummary.CostUSD}}<span class="text-xs font-mono text-muted">{{fmtCost .LastSummary.CostUSD}}</span>{{end}}
        <span class="text-xs text-muted ml-auto">{{fmtTime .LastSummary.StartedAt}}</span>
    </div>
    {{if .LastSummary.Summary}}
    <section class="mb-4">
        <h2 class="section-heading">TL;DR</h2>
        <div class="card-base">
            <p class="text-sm leading-relaxed text-charcoal">{{.LastSummary.Summary}}</p>
        </div>
    </section>
    {{end}}
    {{if .LastSummary.Response}}
    <section class="mb-6">
        <h2 class="section-heading">What Happened</h2>
        <div class="card-base prose">{{renderMarkdown .LastSummary.Response}}</div>
    </section>
    {{end}}
    {{else}}
    <section class="mb-6">
        <h2 class="section-heading">TL;DR</h2>
        <div class="card-base text-sm text-muted">No summary yet. Summaries appear after sessions complete.</div>
    </section>
    {{end}}

    {{/* Unified Activity Feed */}}
    {{/* Governing: SPEC-0021 REQ "Unified Activity Feed" */}}
    <section id="activity-feed"
        hx-get="/" hx-trigger="every 10s" hx-select="#activity-feed-inner" hx-target="#activity-feed-inner" hx-swap="outerHTML">
        <div class="flex items-center justify-between mb-2">
            <h2 class="section-heading mb-0">Activity</h2>
            <span class="text-xs text-muted">auto-refresh 10s</span>
        </div>
        <div id="activity-feed-inner">
        {{if .Activity}}
        <div class="space-y-1">
            {{range .Activity}}
            <div class="card-base flex items-center gap-3 py-1.5 text-sm min-w-0">
                <span class="text-base leading-none w-5 shrink-0 text-center">{{.Icon}}</span>
                {{if eq .Type "event"}}
                <span class="badge-pill {{levelClass .Level}} text-xs shrink-0">{{.Level}}</span>
                {{else if eq .Type "session"}}
                <span class="badge-pill {{statusClass .Level}} text-xs shrink-0">{{.Level}}</span>
                {{else}}
                <span class="badge-pill level-memory text-xs shrink-0">memory</span>
                {{end}}
                {{if .Service}}<span class="text-xs font-mono text-muted bg-surface px-2 py-0.5 rounded shrink-0">{{.Service}}</span>{{end}}
                <span class="flex-1 text-charcoal truncate min-w-0">
                    {{if .SessionID}}<a href="/sessions/{{.SessionID}}" class="text-accent hover:underline font-mono text-xs mr-1">#{{.SessionID}}</a>{{end}}{{.Message}}
                </span>
                <span class="text-xs text-muted font-mono shrink-0">{{fmtTime .Timestamp}}</span>
            </div>
            {{end}}
        </div>
        <div class="mt-3 flex gap-4">
            <a href="/events" class="text-sm text-accent hover:underline">All events &rarr;</a>
            <a href="/sessions" class="text-sm text-accent hover:underline">All sessions &rarr;</a>
        </div>
        {{else}}
        <div class="card-base text-sm text-muted">No activity yet. Events, sessions, and memories will appear here.</div>
        {{end}}
        </div>
    </section>

</div>
{{end}}
