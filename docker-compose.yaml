services:
  watchdog:
    build: .
    container_name: claude-ops
    restart: unless-stopped
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - CLAUDEOPS_INTERVAL=${CLAUDEOPS_INTERVAL:-3600}
      - CLAUDEOPS_TIER1_MODEL=${CLAUDEOPS_TIER1_MODEL:-haiku}
      - CLAUDEOPS_TIER2_MODEL=${CLAUDEOPS_TIER2_MODEL:-sonnet}
      - CLAUDEOPS_TIER3_MODEL=${CLAUDEOPS_TIER3_MODEL:-opus}
      - CLAUDEOPS_DRY_RUN=${CLAUDEOPS_DRY_RUN:-false}
      - CLAUDEOPS_MAX_TIER=${CLAUDEOPS_MAX_TIER:-3}
      - CLAUDEOPS_TIER2_PROMPT=${CLAUDEOPS_TIER2_PROMPT:-prompts/tier2-investigate.md}
      - CLAUDEOPS_TIER3_PROMPT=${CLAUDEOPS_TIER3_PROMPT:-prompts/tier3-remediate.md}
      - CLAUDEOPS_APPRISE_URLS=${CLAUDEOPS_APPRISE_URLS:-}
      - CLAUDEOPS_BROWSER_ALLOWED_ORIGINS=${CLAUDEOPS_BROWSER_ALLOWED_ORIGINS:-}
    ports:
      - "8080:8080"
    volumes:
      - ./state:/state
      - ./results:/results

  # Headless Chrome sidecar for browser automation (credential rotation, web UI checks).
  # Only starts when using: docker compose --profile browser up -d
  chrome:
    image: browserless/chromium
    container_name: claude-ops-chrome
    restart: unless-stopped
    profiles:
      - browser
    ports:
      - "9222:9222"
    environment:
      - CONNECTION_TIMEOUT=120000
      - CHROME_FLAGS=--incognito
