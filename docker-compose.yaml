# Governing: SPEC-0009 REQ "Declarative topology in a single compose file"
# This file is the single source of truth for the Claude Ops deployment topology.
services:
  # Governing: SPEC-0009 REQ "Watchdog service definition"
  watchdog:
    build: .                              # Governing: SPEC-0009 REQ-3 "build from project Dockerfile"
    container_name: claude-ops            # Governing: SPEC-0009 REQ-3 "container_name: claude-ops"
    restart: unless-stopped               # Governing: SPEC-0009 REQ-3, REQ-7 "Restart policy and resilience", ADR-0009
    # Governing: SPEC-0009 REQ-3, REQ-6 "Environment-based configuration"
    # Governing: SPEC-0009 REQ "Restart Policy and Resilience", REQ "Environment-Based Configuration"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - CLAUDEOPS_INTERVAL=${CLAUDEOPS_INTERVAL:-3600}
      - CLAUDEOPS_TIER1_MODEL=${CLAUDEOPS_TIER1_MODEL:-haiku}
      - CLAUDEOPS_TIER2_MODEL=${CLAUDEOPS_TIER2_MODEL:-sonnet}
      - CLAUDEOPS_TIER3_MODEL=${CLAUDEOPS_TIER3_MODEL:-opus}
      - CLAUDEOPS_DRY_RUN=${CLAUDEOPS_DRY_RUN:-false}
      - CLAUDEOPS_MAX_TIER=${CLAUDEOPS_MAX_TIER:-3}
      - CLAUDEOPS_TIER2_PROMPT=${CLAUDEOPS_TIER2_PROMPT:-prompts/tier2-investigate.md}
      - CLAUDEOPS_TIER3_PROMPT=${CLAUDEOPS_TIER3_PROMPT:-prompts/tier3-remediate.md}
      - CLAUDEOPS_APPRISE_URLS=${CLAUDEOPS_APPRISE_URLS:-}
      - CLAUDEOPS_BROWSER_ALLOWED_ORIGINS=${CLAUDEOPS_BROWSER_ALLOWED_ORIGINS:-}
      - CLAUDEOPS_PR_ENABLED=${CLAUDEOPS_PR_ENABLED:-false}
    ports:
      - "8080:8080"
    # Governing: SPEC-0007 REQ-3 — state directory backed by bind mount, persists across restarts/rebuilds
    # Governing: SPEC-0009 REQ-3, REQ-4 "Persistent volume mounts"
    # Governing: SPEC-0009 REQ "Persistent Volume Mounts"
    volumes:
      - ./state:/state
      - ./results:/results
      # Governing: SPEC-0009 REQ-10 "SSH key mounting for remote access"
      # Mount SSH keys for remote host access (container inspection, logs, remediation).
      # Keys MUST be mounted read-only (:ro).
      # - ~/.ssh/id_ed25519:/root/.ssh/id_ed25519:ro
      # - ~/.ssh/known_hosts:/root/.ssh/known_hosts:ro
      # Governing: SPEC-0009 REQ-4 "repos mount from operator-specified host paths"
      # Mount infrastructure repos for service discovery
      # - /path/to/home-cluster:/repos/ansible:ro
      # - /path/to/docker-mirror:/repos/docker-mirror:ro

  # Governing: SPEC-0009 REQ-5 "Optional browser sidecar via profiles"
  # Headless Chrome sidecar for browser automation (credential rotation, web UI checks).
  # Only starts when using: docker compose --profile browser up -d
  chrome:
    image: browserless/chromium  # Governing: SPEC-0009 REQ "Optional Browser Sidecar via Profiles" — browserless/chromium image
    container_name: claude-ops-chrome
    restart: unless-stopped               # Governing: SPEC-0009 REQ-7 "browser sidecar restart policy", REQ-5 "Optional Browser Sidecar via Profiles", ADR-0009
    profiles:
      - browser  # Governing: SPEC-0009 REQ "Optional Browser Sidecar via Profiles" — browser profile
    ports:
      - "9222:9222"  # Governing: SPEC-0009 REQ "Optional Browser Sidecar via Profiles" — CDP port 9222
    environment:
      - CONNECTION_TIMEOUT=120000
      # Governing: SPEC-0014 REQ "Isolated Browser Contexts"
      # — incognito mode ensures no cookies, local storage, or session tokens
      # persist between tasks or leak between services.
      - CHROME_FLAGS=--incognito
