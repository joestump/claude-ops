services:
  watchdog:
    build: .
    container_name: claude-ops
    restart: unless-stopped  # Governing: SPEC-0009 REQ "Restart Policy and Resilience", ADR-0009
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL:-}
      - CLAUDEOPS_INTERVAL=${CLAUDEOPS_INTERVAL:-3600}
      - CLAUDEOPS_TIER1_MODEL=${CLAUDEOPS_TIER1_MODEL:-haiku}
      - CLAUDEOPS_TIER2_MODEL=${CLAUDEOPS_TIER2_MODEL:-sonnet}
      - CLAUDEOPS_TIER3_MODEL=${CLAUDEOPS_TIER3_MODEL:-opus}
      - CLAUDEOPS_DRY_RUN=${CLAUDEOPS_DRY_RUN:-false}
      - CLAUDEOPS_MAX_TIER=${CLAUDEOPS_MAX_TIER:-3}
      - CLAUDEOPS_TIER2_PROMPT=${CLAUDEOPS_TIER2_PROMPT:-prompts/tier2-investigate.md}
      - CLAUDEOPS_TIER3_PROMPT=${CLAUDEOPS_TIER3_PROMPT:-prompts/tier3-remediate.md}
      - CLAUDEOPS_APPRISE_URLS=${CLAUDEOPS_APPRISE_URLS:-}
      - CLAUDEOPS_BROWSER_ALLOWED_ORIGINS=${CLAUDEOPS_BROWSER_ALLOWED_ORIGINS:-}
      - CLAUDEOPS_PR_ENABLED=${CLAUDEOPS_PR_ENABLED:-false}
    ports:
      - "8080:8080"
    # Governing: SPEC-0007 REQ-3 — state directory backed by bind mount, persists across restarts/rebuilds
    volumes:
      - ./state:/state
      - ./results:/results
      # Mount SSH keys for remote host access (container inspection, logs, remediation)
      # - ~/.ssh/id_ed25519:/root/.ssh/id_ed25519:ro
      # - ~/.ssh/known_hosts:/root/.ssh/known_hosts:ro
      # Mount infrastructure repos for service discovery
      # - /path/to/home-cluster:/repos/ansible:ro
      # - /path/to/docker-mirror:/repos/docker-mirror:ro

  # Headless Chrome sidecar for browser automation (credential rotation, web UI checks).
  # Only starts when using: docker compose --profile browser up -d
  chrome:
    image: browserless/chromium
    container_name: claude-ops-chrome
    restart: unless-stopped  # Governing: SPEC-0009 REQ "Restart Policy and Resilience", ADR-0009
    profiles:
      - browser
    ports:
      - "9222:9222"
    environment:
      - CONNECTION_TIMEOUT=120000
      # Governing: SPEC-0014 REQ "Isolated Browser Contexts"
      # — incognito mode ensures no cookies, local storage, or session tokens
      # persist between tasks or leak between services.
      - CHROME_FLAGS=--incognito
